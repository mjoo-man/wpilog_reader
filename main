from fileOps import *

import pandas as pd
import os
import numpy as np
import matplotlib.pyplot as plt
import sys
# define a small function to get an idea of how the code is running
def update_progress(job_title, progress):
    length = 20 # modify this to change the length
    block = int(round(length*progress))
    msg = "\r{0}: [{1}] {2}%".format(job_title, "#"*block + "-"*(length-block),
                round(progress*100, 2))
    if progress >= 1: msg += " DONE\r\n"
    sys.stdout.write(msg)
    sys.stdout.flush()
    return

def main():
	
    # get the directory of the logs to be analyzed
    log_dir = getFilePath("Select Folder with the Logs")

    os.chdir(log_dir)
    # for development use
    # log_dir = r"C:\Users\Micah\Desktop\7_28_rolling tests"

    #create save directory is it doesnt already exist
    save_dir = os.path.join(log_dir, "filled_files")
    os.makedirs(save_dir, exist_ok=True)

    filenames = getCSVFiles(log_dir)
    
    simple_headers = ['Ball Pressure (psi)', 'Ball Pressure MPRLS (psi)', 'Commanded Drive Velocity', 'Commanded Steer Position', 'Drive Angle', 'Drive Velocity', 'Pend Angle', 'Pitch Speed', 'Steer Position', 'Steer Velocity', 'cmdDriveVel', 'drive speed', 'systemTime']
    prog = 0
    for file in filenames:
        update_progress(f"Working on {file}", prog/len(filenames))
        prog+=1
        # just read the headers of each file 
        headers = pd.read_csv(file, index_col=0, nrows=0).columns.tolist()

        # read data in the enabled disabled
        run_data = pd.read_csv(file, index_col=0) # timestamp is the index

        fill_data = run_data.fillna(method="ffill") # forward fill all nan with the preceeding number
        fill_data = fill_data.fillna(0.0) # get the first nan to be zero


        #title the file after the first file picked and add merged
        os.chdir(save_dir)
        newName = os.path.basename(file).split(".")[0] + '-filled.csv'
        fill_data.to_csv(newName)
        os.chdir(log_dir)


         # get rid of some crap 
        # for i in range(len(headers)):
        #     headers[i] = headers[i].replace("NT:/SmartDashboard/", "")
        # print(headers)
        

main()